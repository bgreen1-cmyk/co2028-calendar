<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CO2028 ‚Äî Academic Calendar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#161b27;--surface2:#1e2535;--surface3:#242d3f;
  --border:#2a3147;--text:#e8eaf0;--muted:#7a829a;--muted2:#5a6280;--accent:#4f8ef7;
  --heme:#f05c6e;--resp:#4f8ef7;--renal:#3ecf8e;--gi:#f7a14f;--endo:#b97cf7;--msk:#4fd6f7;
  --cat-mandatory:#4f8ef7;--cat-faculty:#3ecf8e;--cat-tbl:#b97cf7;
  --cat-cbse:#f05c6e;--cat-session:#4a5168;--cat-itde:#4fd6f7;--cat-exam:#f7a14f;
  --gold:#f7c94f;
}
html,body{min-height:100vh;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px}

/* CONFIG */
.config-overlay{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px}
.config-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.config-box h1{font-size:22px;font-weight:700;margin-bottom:6px}
.config-box .sub{font-size:13px;color:var(--muted);margin-bottom:28px;line-height:1.6}
.config-step{display:flex;gap:14px;margin-bottom:20px;align-items:flex-start}
.config-num{width:26px;height:26px;border-radius:50%;background:var(--accent);color:white;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
.config-step-body{flex:1}
.config-step-body label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);display:block;margin-bottom:6px}
.config-step-body input{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;outline:none;transition:border-color .15s}
.config-step-body input:focus{border-color:var(--accent)}
.config-step-body .hint{font-size:11px;color:var(--muted2);margin-top:5px;line-height:1.5}
.config-step-body .hint code{background:var(--surface3);padding:1px 6px;border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;color:var(--accent)}
.config-btn{width:100%;padding:12px;border-radius:10px;border:none;background:var(--accent);color:white;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;margin-top:8px;transition:all .15s}
.config-btn:hover{background:#3a7de8}
.config-err{font-size:12px;color:#f05c6e;margin-top:10px;min-height:18px;text-align:center;line-height:1.5}
.security-note{margin-top:16px;padding:12px;background:rgba(62,207,142,.08);border:1px solid rgba(62,207,142,.2);border-radius:8px;font-size:11px;color:#3ecf8e;line-height:1.6}

/* HEADER */
.header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;gap:14px;height:56px;position:sticky;top:0;z-index:200}
.logo{font-size:15px;font-weight:600;display:flex;align-items:center;gap:10px}
.logo-badge{background:var(--accent);color:white;font-family:'DM Mono',monospace;font-size:11px;padding:3px 8px;border-radius:4px}
.header-center{flex:1;display:flex;justify-content:center}
.mode-toggle{display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--surface2)}
.mode-btn{padding:6px 18px;background:transparent;border:none;font-size:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;color:var(--muted);transition:all .15s}
.mode-btn.active{background:var(--accent);color:white}
.mode-btn.faculty-active{background:var(--gold);color:#1a1200}
.header-right{display:flex;align-items:center;gap:8px}
.btn-sm{padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:500;transition:all .15s}
.btn-sm:hover{background:var(--surface2);color:var(--text)}
.btn-sm.gold{background:var(--gold);color:#1a1200;border-color:var(--gold);font-weight:700}
.btn-sm.outlook{border-color:#0078d433;color:#4f8ef7}
.faculty-badge{background:var(--gold);color:#1a1200;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}

/* STATUS */
.status-bar{background:var(--surface2);border-bottom:1px solid var(--border);padding:6px 24px;display:flex;align-items:center;gap:10px;font-size:11px;color:var(--muted)}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status-dot.live{background:#3ecf8e;box-shadow:0 0 6px #3ecf8e88;animation:blink 2s infinite}
.status-dot.offline{background:var(--muted2)}
.status-dot.loading{background:var(--gold);animation:blink 1s infinite}
.status-right{margin-left:auto;font-size:10px;color:var(--muted2)}

/* LAYOUT */
.layout{display:flex;min-height:calc(100vh - 56px)}

/* SIDEBAR */
.sidebar{width:220px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);padding:20px 0;position:sticky;top:56px;height:calc(100vh - 56px);overflow-y:auto;display:flex;flex-direction:column}
.sb-section{margin-bottom:8px}
.sb-heading{font-size:10px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted2);padding:8px 20px 5px}
.sb-item{display:flex;align-items:center;gap:10px;padding:8px 20px;font-size:13px;color:var(--muted);cursor:pointer;transition:all .12s;border-left:3px solid transparent}
.sb-item:hover{color:var(--text);background:var(--surface2)}
.sb-item.active{color:var(--text);background:rgba(79,142,247,.09);border-left-color:var(--accent)}
.sb-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.sb-count{margin-left:auto;font-size:10px;color:var(--muted2);font-family:'DM Mono',monospace}

/* MAIN */
.main{flex:1;padding:24px;overflow-x:auto;min-width:0}
.toolbar{display:flex;align-items:flex-start;gap:12px;margin-bottom:18px;flex-wrap:wrap}
.toolbar-left{flex:1;min-width:0}
.toolbar-title{font-size:20px;font-weight:600;letter-spacing:-.5px}
.toolbar-sub{font-size:12px;color:var(--muted);margin-top:3px}
.view-toggle{display:flex;border:1px solid var(--border);border-radius:7px;overflow:hidden}
.vt-btn{padding:6px 14px;background:transparent;border:none;font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;color:var(--muted);transition:all .12s;font-weight:500}
.vt-btn.active{background:var(--accent);color:white}
.vt-btn:not(.active):hover{background:var(--surface2);color:var(--text)}
.week-drawer{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:16px}
.wk-btn{padding:4px 11px;border-radius:20px;border:1px solid var(--border);font-size:11px;cursor:pointer;background:transparent;color:var(--muted);transition:all .15s;font-family:'DM Sans',sans-serif;font-weight:500;white-space:nowrap}
.wk-btn:hover{color:var(--text);border-color:var(--muted2)}
.wk-btn.active{color:white;border-color:transparent;font-weight:600}
.filter-row{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.filter-label{font-size:10px;color:var(--muted2);font-weight:700;text-transform:uppercase;letter-spacing:.8px}
.filter-chip{padding:4px 12px;border-radius:20px;border:1px solid var(--border);font-size:11px;cursor:pointer;background:transparent;color:var(--muted);transition:all .12s;font-family:'DM Sans',sans-serif;font-weight:500}
.filter-chip:hover{color:var(--text);border-color:var(--muted2)}
.filter-chip.active{color:white;border-color:transparent}
.week-nav{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.nav-btn{width:30px;height:30px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.nav-btn:hover{background:var(--surface2);color:var(--text)}
.week-label{font-size:14px;font-weight:700;font-family:'DM Mono',monospace}
.block-pill{font-size:11px;font-weight:700;padding:3px 11px;border-radius:20px}
.week-dates{font-size:12px;color:var(--muted)}

/* CALENDAR */
.cal-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;min-width:640px}
.cal-header{display:grid;grid-template-columns:64px repeat(5,1fr);background:var(--surface2);border-bottom:1px solid var(--border)}
.ch-cell{padding:10px 8px;text-align:center;border-right:1px solid var(--border)}
.ch-cell:last-child{border-right:none}
.ch-day{font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--muted)}
.ch-num{font-size:20px;font-weight:300;color:var(--text);line-height:1.2;margin-top:2px}
.ch-cell.today .ch-num{background:var(--accent);color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;margin:2px auto 0;font-weight:600;font-size:14px}
.cal-row{display:grid;grid-template-columns:64px repeat(5,1fr);border-bottom:1px solid var(--border);min-height:52px}
.cal-row:last-child{border-bottom:none}
.cal-time{padding:8px 6px 8px 6px;font-size:10px;color:var(--muted2);border-right:1px solid var(--border);text-align:right;font-family:'DM Mono',monospace;display:flex;align-items:flex-start;justify-content:flex-end}
.cal-cell{border-right:1px solid var(--border);padding:3px;position:relative;min-height:52px}
.cal-cell:last-child{border-right:none}
.faculty-mode .cal-cell:hover .add-slot-btn{display:flex}
.add-slot-btn{display:none;position:absolute;inset:3px;border-radius:5px;border:2px dashed var(--gold);background:rgba(247,201,79,.05);color:var(--gold);font-size:18px;cursor:pointer;align-items:center;justify-content:center;z-index:5}
.add-slot-btn:hover{background:rgba(247,201,79,.12)}

/* EVENTS */
.event{border-radius:5px;padding:5px 7px;font-size:11px;font-weight:500;cursor:pointer;transition:transform .1s,box-shadow .15s;line-height:1.3;height:100%;min-height:44px;display:flex;flex-direction:column;justify-content:center;border-left:3px solid;position:relative;z-index:2;animation:fadeIn .2s ease}
.event:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.35)}
@keyframes fadeIn{from{opacity:0;transform:translateY(2px)}to{opacity:1;transform:none}}
.ev-tag{font-size:9px;text-transform:uppercase;letter-spacing:.7px;font-weight:700;opacity:.7;margin-bottom:2px}
.ev-title{font-size:11px;line-height:1.3}
.ev-time{font-size:9px;margin-top:3px;opacity:.6;font-family:'DM Mono',monospace}
.ev-controls{display:none;position:absolute;top:3px;right:3px;gap:3px;z-index:10}
.faculty-mode .event:hover .ev-controls{display:flex}
.ev-ctrl-btn{width:20px;height:20px;border-radius:4px;border:none;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.ev-edit-btn{background:rgba(0,0,0,.4);color:var(--gold)}
.ev-edit-btn:hover{background:var(--gold);color:#1a1200}
.ev-del-btn{background:rgba(0,0,0,.4);color:#f05c6e}
.ev-del-btn:hover{background:#f05c6e;color:white}
.event.Mandatory{background:rgba(79,142,247,.18);border-color:#4f8ef7;color:#a8c8ff}
.event.Faculty{background:rgba(62,207,142,.15);border-color:#3ecf8e;color:#7fe8bc}
.event.TBL{background:rgba(185,124,247,.18);border-color:#b97cf7;color:#d4b0ff}
.event.CBSE{background:rgba(240,92,110,.18);border-color:#f05c6e;color:#ffa0aa}
.event.Session{background:rgba(122,130,154,.12);border-color:#4a5168;color:#9aa0b4}
.event.ITDE{background:rgba(79,214,247,.15);border-color:#4fd6f7;color:#9aeeff}
.event.ExamReview{background:rgba(247,161,79,.18);border-color:#f7a14f;color:#ffc98a}
.event.GrandRounds{background:rgba(247,161,79,.18);border-color:#f7a14f;color:#ffc98a}

/* FACULTY PANEL */
.faculty-panel{display:none;position:fixed;top:0;right:0;width:360px;height:100vh;background:var(--surface);border-left:2px solid var(--gold);z-index:250;overflow-y:auto;flex-direction:column;box-shadow:-8px 0 30px rgba(0,0,0,.4)}
.faculty-panel.open{display:flex}
.fp-header{padding:18px 20px 14px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(247,201,79,.1) 0%,transparent 60%)}
.fp-title{font-size:15px;font-weight:700;color:var(--gold)}
.fp-sub{font-size:11px;color:var(--muted);margin-top:4px}
.fp-body{padding:20px;flex:1}
.fp-section{margin-bottom:24px}
.fp-section-title{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted2);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.form-group{margin-bottom:14px}
.form-label{font-size:11px;font-weight:600;color:var(--muted);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:.5px}
.form-input,.form-select{width:100%;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;transition:border-color .15s;outline:none}
.form-input:focus,.form-select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(247,201,79,.1)}
.form-select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a829a' fill='none' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
.form-select option{background:var(--surface2)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.color-preview{display:flex;align-items:center;gap:8px;margin-top:6px}
.color-dot{width:12px;height:12px;border-radius:50%}
.btn-full{width:100%;padding:10px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;margin-bottom:8px}
.btn-save{background:var(--gold);color:#1a1200}
.btn-save:hover{background:#f0bc3a}
.btn-cancel{background:var(--surface2);color:var(--muted);border:1px solid var(--border)}
.btn-delete-full{background:rgba(240,92,110,.15);color:#f05c6e;border:1px solid rgba(240,92,110,.3)}
.change-item{padding:10px 12px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);margin-bottom:8px;font-size:12px}
.change-item .ch-type{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.change-item .ch-title{color:var(--text);font-weight:500}
.change-item .ch-meta{color:var(--muted);font-size:11px;margin-top:2px}
.change-added .ch-type{color:#3ecf8e}
.change-edited .ch-type{color:var(--gold)}
.change-deleted .ch-type{color:#f05c6e}
.fp-footer{padding:16px 20px;border-top:1px solid var(--border);background:var(--surface2)}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:500;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:460px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:modalIn .2s cubic-bezier(.34,1.56,.64,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px}
.modal-bar{width:4px;border-radius:4px;flex-shrink:0;align-self:stretch;min-height:40px}
.modal-title{font-size:16px;font-weight:600;line-height:1.4;flex:1}
.modal-close{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--surface2);color:var(--text)}
.modal-body{padding:20px 24px}
.modal-row{display:flex;gap:12px;margin-bottom:14px;align-items:flex-start}
.m-icon{font-size:16px;width:22px;flex-shrink:0;margin-top:1px}
.m-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.m-val{font-size:13px;color:var(--text)}
.modal-footer{padding:0 24px 20px}
.modal-week{font-size:11px;color:var(--muted);border-top:1px solid var(--border);padding-top:14px;font-family:'DM Mono',monospace}

/* MISC */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-state .big{font-size:40px;margin-bottom:12px}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);color:var(--text);padding:12px 22px;border-radius:30px;font-size:13px;font-weight:500;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.4);transition:opacity .3s;white-space:nowrap;pointer-events:none}
.login-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:700;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.login-overlay.open{display:flex}
.login-box{background:var(--surface);border:1px solid var(--gold);border-radius:14px;padding:32px;max-width:320px;width:90%;text-align:center;animation:modalIn .2s ease}
.login-box h2{font-size:18px;font-weight:700;color:var(--gold);margin-bottom:6px}
.login-box p{font-size:12px;color:var(--muted);margin-bottom:20px;line-height:1.5}
.login-box input{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:16px;text-align:center;letter-spacing:4px;outline:none;margin-bottom:14px;transition:border-color .15s}
.login-box input:focus{border-color:var(--gold)}
.login-err{font-size:12px;color:#f05c6e;margin-bottom:10px;min-height:18px}
.login-submit{width:100%;padding:10px;border-radius:8px;border:none;background:var(--gold);color:#1a1200;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer}
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:600;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.confirm-overlay.open{display:flex}
.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px;max-width:340px;width:90%;text-align:center;animation:modalIn .15s ease}
.confirm-box h3{font-size:16px;font-weight:600;margin-bottom:8px;color:#f05c6e}
.confirm-box p{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.5}
.confirm-btns{display:flex;gap:10px;justify-content:center}
.confirm-btns button{padding:9px 22px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:1px solid var(--border)}
#confirmYes{background:#f05c6e;color:white;border-color:#f05c6e}
#confirmNo{background:var(--surface2);color:var(--muted)}
@media(max-width:768px){.sidebar{display:none}.main{padding:16px}.cal-wrap{min-width:0}.cal-header,.cal-row{grid-template-columns:44px repeat(5,1fr)}.ev-tag,.ev-time{display:none}.ev-title{font-size:10px}.faculty-panel{width:100%}}
</style>
</head>
<body>

<!-- CONFIG SCREEN -->
<div class="config-overlay" id="configOverlay">
  <div class="config-box">
    <h1>üìÖ CO2028 Calendar Setup</h1>
    <p class="sub">Connect to your GitHub repository so all edits are live and shared with everyone instantly ‚Äî no IT needed.</p>

    <div class="config-step">
      <div class="config-num">1</div>
      <div class="config-step-body">
        <label>GitHub Username</label>
        <input id="cfgUser" type="text" placeholder="e.g. bgreen1-cmyk" value="">
        <div class="hint">Your GitHub username ‚Äî visible in your profile URL: <code>github.com/YOUR-USERNAME</code></div>
      </div>
    </div>

    <div class="config-step">
      <div class="config-num">2</div>
      <div class="config-step-body">
        <label>Repository Name</label>
        <input id="cfgRepo" type="text" placeholder="co2028-calendar" value="co2028-calendar">
        <div class="hint">The name of your GitHub repository where the calendar is hosted.</div>
      </div>
    </div>

    <div class="config-step">
      <div class="config-num">3</div>
      <div class="config-step-body">
        <label>GitHub Token (Faculty only ‚Äî students leave blank)</label>
        <input id="cfgToken" type="password" placeholder="ghp_... (only needed for editing)">
        <div class="hint">Students leave this blank ‚Äî they only need to view. Faculty paste their token here to enable editing. Stored only in your browser, never sent anywhere else.</div>
      </div>
    </div>

    <div class="config-step">
      <div class="config-num">4</div>
      <div class="config-step-body">
        <label>Faculty PIN</label>
        <input id="cfgPin" type="password" placeholder="Set a PIN" value="2028">
        <div class="hint">Faculty enter this PIN to unlock the edit panel.</div>
      </div>
    </div>

    <button class="config-btn" onclick="saveConfig()">Connect to GitHub ‚Üí</button>
    <div class="config-err" id="cfgErr"></div>
    <div class="security-note">üîí Your token is stored only in your browser's local storage. It is never transmitted to any server other than GitHub's official API (api.github.com).</div>
  </div>
</div>

<!-- HEADER -->
<div class="header" id="appHeader" style="display:none">
  <div class="logo"><span class="logo-badge">CO2028</span> Academic Calendar</div>
  <div class="header-center">
    <div class="mode-toggle">
      <button class="mode-btn active" onclick="setMode('student')">üëÅ Student</button>
      <button class="mode-btn" id="facultyModeBtn" onclick="requestFacultyMode()">‚úèÔ∏è Faculty</button>
    </div>
  </div>
  <div class="header-right">
    <span class="faculty-badge" id="facultyBadge" style="display:none">LIVE EDITING</span>
    <button class="btn-sm gold" id="addEventBtn" style="display:none" onclick="openAddForm()">+ Add Event</button>
    <button class="btn-sm outlook" onclick="exportICS()">üìÖ Export to Outlook</button>
    <button class="btn-sm" onclick="loadEvents()" title="Refresh">‚Üª</button>
    <button class="btn-sm" onclick="openConfig()">‚öô</button>
  </div>
</div>

<!-- STATUS BAR -->
<div class="status-bar" id="statusBar" style="display:none">
  <div class="status-dot loading" id="statusDot"></div>
  <span id="statusMsg">Connecting...</span>
  <div class="status-right" id="lastSync"></div>
</div>

<!-- LAYOUT -->
<div class="layout faculty-mode" id="layout" style="display:none">
  <div class="sidebar">
    <div class="sb-section">
      <div class="sb-heading">Blocks</div>
      <div class="sb-item active" data-block="All" onclick="setSidebarBlock(this,'All')"><div class="sb-dot" style="background:var(--muted)"></div>All Blocks</div>
      <div class="sb-item" data-block="Heme/Onc" onclick="setSidebarBlock(this,'Heme/Onc')"><div class="sb-dot" style="background:var(--heme)"></div>Heme/Onc<span class="sb-count">28‚Äì30</span></div>
      <div class="sb-item" data-block="Respiratory" onclick="setSidebarBlock(this,'Respiratory')"><div class="sb-dot" style="background:var(--resp)"></div>Respiratory<span class="sb-count">31‚Äì34</span></div>
      <div class="sb-item" data-block="Renal" onclick="setSidebarBlock(this,'Renal')"><div class="sb-dot" style="background:var(--renal)"></div>Renal<span class="sb-count">35‚Äì38</span></div>
      <div class="sb-item" data-block="GI" onclick="setSidebarBlock(this,'GI')"><div class="sb-dot" style="background:var(--gi)"></div>GI<span class="sb-count">39‚Äì42</span></div>
      <div class="sb-item" data-block="Endocrinology" onclick="setSidebarBlock(this,'Endocrinology')"><div class="sb-dot" style="background:var(--endo)"></div>Endocrinology<span class="sb-count">43‚Äì47</span></div>
      <div class="sb-item" data-block="MSK" onclick="setSidebarBlock(this,'MSK')"><div class="sb-dot" style="background:var(--msk)"></div>MSK<span class="sb-count">49‚Äì51</span></div>
    </div>
    <div class="sb-section">
      <div class="sb-heading">Event Type</div>
      <div class="sb-item" onclick="setSidebarCat(this,'Mandatory')"><div class="sb-dot" style="background:var(--cat-mandatory)"></div>Mandatory</div>
      <div class="sb-item" onclick="setSidebarCat(this,'Faculty Discussion')"><div class="sb-dot" style="background:var(--cat-faculty)"></div>Faculty Discussion</div>
      <div class="sb-item" onclick="setSidebarCat(this,'TBL')"><div class="sb-dot" style="background:var(--cat-tbl)"></div>TBL</div>
      <div class="sb-item" onclick="setSidebarCat(this,'CBSE')"><div class="sb-dot" style="background:var(--cat-cbse)"></div>CBSE / Exam</div>
    </div>
  </div>

  <div class="main">
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="toolbar-title">CO2028 Academic Calendar ‚Äî Fall 2025</div>
        <div class="toolbar-sub" id="toolbarSub">Loading...</div>
      </div>
      <div class="view-toggle">
        <button class="vt-btn active" onclick="setView('week',this)">Week</button>
        <button class="vt-btn" onclick="setView('list',this)">List</button>
      </div>
    </div>
    <div class="week-drawer" id="weekDrawer"></div>
    <div class="filter-row">
      <span class="filter-label">Show:</span>
      <span class="filter-chip active" data-cat="All" onclick="setFilter(this,'All')">All Events</span>
      <span class="filter-chip" data-cat="Mandatory" onclick="setFilter(this,'Mandatory')">Mandatory</span>
      <span class="filter-chip" data-cat="Faculty Discussion" onclick="setFilter(this,'Faculty Discussion')">Faculty Discussion</span>
      <span class="filter-chip" data-cat="TBL" onclick="setFilter(this,'TBL')">TBL</span>
      <span class="filter-chip" data-cat="CBSE" onclick="setFilter(this,'CBSE')">CBSE</span>
    </div>
    <div class="week-nav">
      <button class="nav-btn" onclick="prevWeek()">‚Äπ</button>
      <button class="nav-btn" onclick="nextWeek()">‚Ä∫</button>
      <span class="week-label" id="weekLabel">‚Äî</span>
      <span class="block-pill" id="blockPill"></span>
      <span class="week-dates" id="weekDates"></span>
    </div>
    <div id="calView"><div style="text-align:center;padding:60px 20px"><div class="spinner"></div><p style="color:var(--muted)">Loading events...</p></div></div>
  </div>

  <!-- FACULTY PANEL -->
  <div class="faculty-panel" id="facultyPanel">
    <div class="fp-header">
      <div class="fp-title">‚úèÔ∏è Faculty Editor</div>
      <div class="fp-sub" id="fpSub">Click an event to edit ¬∑ Click a slot to add</div>
    </div>
    <div class="fp-body">
      <div class="fp-section">
        <div class="fp-section-title">Add / Edit Event</div>
        <div id="fpForm"><div style="text-align:center;padding:30px 0;color:var(--muted)"><div style="font-size:28px;margin-bottom:10px">üëÜ</div><div style="font-size:12px;line-height:1.6">Click an event to edit,<br>or click a time slot to add,<br>or press <strong style="color:var(--gold)">+ Add Event</strong> above.</div></div></div>
      </div>
      <div class="fp-section">
        <div class="fp-section-title">Recent Changes <span id="changeCount" style="color:var(--muted2);font-size:9px;font-family:monospace"></span></div>
        <div id="changeLog"><div style="font-size:11px;color:var(--muted2);padding:8px 0">No changes this session.</div></div>
      </div>
    </div>
    <div class="fp-footer">
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px;line-height:1.5">Changes save directly to GitHub ‚Äî everyone sees updates within seconds.</div>
      <button class="btn-full" onclick="exportICS()" style="background:#0078d4;color:white;padding:10px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer">üìÖ Export to Outlook (.ics)</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target.id==='modalOverlay')this.classList.remove('open')">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-bar" id="modalBar"></div>
      <div style="flex:1">
        <div id="modalCat" style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;opacity:.75"></div>
        <div class="modal-title" id="modalTitle"></div>
      </div>
      <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('open')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-row"><div class="m-icon">üóì</div><div><div class="m-label">Date &amp; Time</div><div class="m-val" id="modalDate"></div></div></div>
      <div class="modal-row"><div class="m-icon">üìö</div><div><div class="m-label">Block</div><div class="m-val" id="modalBlock"></div></div></div>
    </div>
    <div class="modal-footer"><div class="modal-week" id="modalWeek"></div></div>
  </div>
</div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3>Delete Event?</h3>
    <p id="confirmMsg">This will be permanently removed.</p>
    <div class="confirm-btns">
      <button id="confirmNo" onclick="document.getElementById('confirmOverlay').classList.remove('open')">Cancel</button>
      <button id="confirmYes">Delete</button>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div style="font-size:32px;margin-bottom:10px">üîê</div>
    <h2>Faculty Access</h2>
    <p>Enter your PIN to enable live editing.</p>
    <input type="password" id="pinInput" maxlength="10" onkeydown="if(event.key==='Enter')checkPin()">
    <div class="login-err" id="pinErr"></div>
    <button class="login-submit" onclick="checkPin()">Unlock</button>
    <button style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer" onclick="document.getElementById('loginOverlay').classList.remove('open')">Cancel</button>
  </div>
</div>

<script>
const BLOCK_COLOR={'Heme/Onc':'#f05c6e','Respiratory':'#4f8ef7','Renal':'#3ecf8e','GI':'#f7a14f','Endocrinology':'#b97cf7','MSK':'#4fd6f7','Break':'#7a829a'};
const CAT_COLOR={'Mandatory':'#4f8ef7','Faculty Discussion':'#3ecf8e','TBL':'#b97cf7','CBSE':'#f05c6e','Session':'#4a5168','ITDE':'#4fd6f7','Exam Review':'#f7a14f','Grand Rounds':'#f7a14f'};
const BLOCKS_LIST=['Heme/Onc','Respiratory','Renal','GI','Endocrinology','MSK','Break'];
const CATS_LIST=['Mandatory','Faculty Discussion','TBL','CBSE','ITDE','Exam Review','Session','Grand Rounds'];
const HOUR_KEYS=['08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00'];
const HOURS=['8 AM','9 AM','10 AM','11 AM','12 PM','1 PM','2 PM','3 PM','4 PM'];
const DAYS=['Mon','Tue','Wed','Thu','Fri'];

let CFG={}, EVENTS=[], WEEKS=[];
let currentWeekIdx=0, currentFilter='All', currentView='week';
let isFacultyMode=false, editingId=null, prefillDate='', prefillHour='';
let pendingDeleteId='', sessionLog=[];
let ghFileSha=''; // GitHub file SHA needed for updates

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadConfig(){
  try{CFG=JSON.parse(localStorage.getItem('co2028_gh_cfg')||'{}');}catch(e){CFG={};}
  return !!(CFG.user && CFG.repo);
}
function saveConfig(){
  const user=document.getElementById('cfgUser').value.trim();
  const repo=document.getElementById('cfgRepo').value.trim();
  const token=document.getElementById('cfgToken').value.trim();
  const pin=document.getElementById('cfgPin').value.trim();
  if(!user){document.getElementById('cfgErr').textContent='Please enter your GitHub username.';return;}
  if(!repo){document.getElementById('cfgErr').textContent='Please enter your repository name.';return;}
  CFG={user,repo,token,pin:pin||'2028'};
  localStorage.setItem('co2028_gh_cfg',JSON.stringify(CFG));
  document.getElementById('configOverlay').style.display='none';
  initApp();
}
function openConfig(){
  document.getElementById('cfgUser').value=CFG.user||'';
  document.getElementById('cfgRepo').value=CFG.repo||'co2028-calendar';
  document.getElementById('cfgToken').value=CFG.token||'';
  document.getElementById('cfgPin').value=CFG.pin||'2028';
  document.getElementById('cfgErr').textContent='';
  document.getElementById('configOverlay').style.display='flex';
}

// ‚îÄ‚îÄ GITHUB API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DATA_FILE = 'events.json';

function ghHeaders(){
  const h={'Accept':'application/vnd.github.v3+json'};
  if(CFG.token) h['Authorization']='token '+CFG.token;
  return h;
}

async function loadEvents(){
  setStatus('loading','Loading events...');
  document.getElementById('calView').innerHTML='<div style="text-align:center;padding:60px 20px"><div class="spinner"></div><p style="color:var(--muted)">Loading from GitHub...</p></div>';
  try{
    // Use raw content URL ‚Äî no auth needed, no CORS issues
    const rawUrl=`https://raw.githubusercontent.com/${CFG.user}/${CFG.repo}/main/${DATA_FILE}?t=${Date.now()}`;
    const r=await fetch(rawUrl);
    if(!r.ok) throw new Error(`Could not load events.json (${r.status}). Make sure the file exists in your repo.`);
    EVENTS=await r.json();
    // Also get SHA for future updates (needs token)
    if(CFG.token){
      try{
        const meta=await fetch(`https://api.github.com/repos/${CFG.user}/${CFG.repo}/contents/${DATA_FILE}`,{headers:ghHeaders()});
        if(meta.ok){const d=await meta.json();ghFileSha=d.sha;}
      }catch(e){}
    }
    setStatus('live',`Live ‚Äî ${EVENTS.length} events`);
    document.getElementById('lastSync').textContent='Last sync: '+new Date().toLocaleTimeString();
    WEEKS=buildWeeks();
    buildWeekDrawer();
    render();
  }catch(err){
    setStatus('offline','Error: '+err.message.substring(0,60));
    showToast('‚ùå '+err.message);
    document.getElementById('calView').innerHTML=`<div class="empty-state"><div class="big">‚ùå</div><p>${err.message}</p><p style="margin-top:10px;font-size:11px">Make sure <strong>events.json</strong> exists in your GitHub repo.</p></div>`;
  }
}

async function saveEventsToGitHub(){
  if(!CFG.token) throw new Error('No GitHub token ‚Äî open ‚öô settings and add your token to enable saving.');
  const content=btoa(unescape(encodeURIComponent(JSON.stringify(EVENTS,null,2))));
  const body={message:'Update calendar events',content,sha:ghFileSha};
  const r=await fetch(`https://api.github.com/repos/${CFG.user}/${CFG.repo}/contents/${DATA_FILE}`,{
    method:'PUT',headers:{...ghHeaders(),'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  if(!r.ok){const t=await r.text();throw new Error(`GitHub save failed (${r.status}): ${t.substring(0,100)}`);}
  const d=await r.json();
  ghFileSha=d.content.sha; // update SHA for next save
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initApp(){
  document.getElementById('configOverlay').style.display='none';
  document.getElementById('appHeader').style.display='flex';
  document.getElementById('statusBar').style.display='flex';
  document.getElementById('layout').style.display='flex';
  loadEvents();
}

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(state,msg){
  document.getElementById('statusDot').className='status-dot '+state;
  document.getElementById('statusMsg').textContent=msg;
}

// ‚îÄ‚îÄ WEEKS / NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildWeeks(){
  const map={},seen=new Set();
  EVENTS.forEach(e=>{if(!seen.has(e.weekNum)){seen.add(e.weekNum);map[e.weekNum]={num:e.weekNum,name:e.week,block:e.block};}});
  return Object.values(map).sort((a,b)=>a.num-b.num);
}
function buildWeekDrawer(){
  document.getElementById('weekDrawer').innerHTML=WEEKS.map((w,i)=>{
    const col=BLOCK_COLOR[w.block]||'#7a829a';
    const lbl=w.name.replace(/\s*\(\d+\)/,'').replace(/WEEK/i,'Wk').replace(/Week/,'Wk');
    return `<button class="wk-btn${i===currentWeekIdx?' active':''}" style="${i===currentWeekIdx?'background:'+col+';border-color:'+col:''}" onclick="jumpToWeek(${i})">${lbl}</button>`;
  }).join('');
}
function jumpToWeek(i){currentWeekIdx=i;buildWeekDrawer();render();}
function prevWeek(){if(currentWeekIdx>0){currentWeekIdx--;buildWeekDrawer();render();}}
function nextWeek(){if(currentWeekIdx<WEEKS.length-1){currentWeekIdx++;buildWeekDrawer();render();}}
function setSidebarBlock(el,block){
  document.querySelectorAll('.sb-item[data-block]').forEach(i=>i.classList.remove('active'));
  el.classList.add('active');
  if(block!=='All'){const i=WEEKS.findIndex(w=>w.block===block);if(i>=0){currentWeekIdx=i;buildWeekDrawer();render();return;}}
  render();
}
function setSidebarCat(el,cat){currentFilter=cat;document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));const ch=document.querySelector(`.filter-chip[data-cat="${cat}"]`);if(ch)ch.classList.add('active');render();}
function setFilter(el,cat){currentFilter=cat;document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');render();}
function setView(v,btn){currentView=v;document.querySelectorAll('.vt-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');render();}

// ‚îÄ‚îÄ TIME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtTime(t){const[h,m]=t.split(':').map(Number);return`${h>12?h-12:h===0?12:h}:${String(m).padStart(2,'0')} ${h>=12?'PM':'AM'}`;}
function fmtDate(d){const[mo,dy,yr]=d.split('/');return new Date(yr,mo-1,dy).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});}
function getWeekDates(){
  const w=WEEKS[currentWeekIdx];
  const evs=EVENTS.filter(e=>e.weekNum===w.num);
  const dates=[...new Set(evs.map(e=>e.date))].sort((a,b)=>{const pa=a.split('/'),pb=b.split('/');return new Date(pa[2],pa[0]-1,pa[1])-new Date(pb[2],pb[0]-1,pb[1]);});
  if(!dates.length)return Array(5).fill('');
  const[mo,dy,yr]=dates[0].split('/').map(Number);
  const d=new Date(yr,mo-1,dy),dow=d.getDay(),mon=new Date(d);
  mon.setDate(d.getDate()-(dow===0?6:dow-1));
  return Array.from({length:5},(_,i)=>{const dd=new Date(mon);dd.setDate(mon.getDate()+i);return`${String(dd.getMonth()+1).padStart(2,'0')}/${String(dd.getDate()).padStart(2,'0')}/${dd.getFullYear()}`;});
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  if(!WEEKS.length)return;
  const w=WEEKS[currentWeekIdx],col=BLOCK_COLOR[w.block]||'#7a829a';
  document.getElementById('weekLabel').textContent=`Week ${w.num}`;
  const pill=document.getElementById('blockPill');
  pill.textContent=w.block;pill.style.background=col+'22';pill.style.color=col;pill.style.border='1px solid '+col+'55';
  const dates=getWeekDates();
  if(dates[0]){
    const[mo1,dy1]=dates[0].split('/');const[mo2,dy2]=dates[4].split('/');
    const d1=new Date(2025,+mo1-1,+dy1),d2=new Date(2025,+mo2-1,+dy2);
    document.getElementById('weekDates').textContent=d1.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' ‚Äì '+d2.toLocaleDateString('en-US',{month:'short',day:'numeric'})+', 2025';
  }
  document.getElementById('toolbarSub').textContent=`Fall 2025 ¬∑ ${EVENTS.length} events ¬∑ ${EVENTS.filter(e=>e.weekNum===w.num).length} this week`;
  renderChangeLog();
  if(currentView==='week')renderWeek(dates);else renderList();
}

function evClass(e){if(e.category==='Faculty Discussion')return'Faculty';if(e.category==='Exam Review')return'ExamReview';if(e.category==='Grand Rounds')return'GrandRounds';return e.category.replace(/\s/g,'');}

function renderWeek(dates){
  const w=WEEKS[currentWeekIdx];
  const evs=EVENTS.filter(e=>e.weekNum===w.num&&(currentFilter==='All'||e.category===currentFilter));
  const today=new Date();
  const todayStr=`${String(today.getMonth()+1).padStart(2,'0')}/${String(today.getDate()).padStart(2,'0')}/${today.getFullYear()}`;
  let html=`<div class="cal-wrap"><div class="cal-header"><div class="ch-cell"></div>`;
  DAYS.forEach((day,i)=>{
    const ds=dates[i]||'';const[,dy]=(ds||'//').split('/');
    html+=`<div class="ch-cell${ds===todayStr?' today':''}"><div class="ch-day">${day}</div><div class="ch-num">${dy?+dy:''}</div></div>`;
  });
  html+='</div>';
  HOUR_KEYS.forEach((hk,hi)=>{
    html+=`<div class="cal-row"><div class="cal-time">${HOURS[hi]}</div>`;
    dates.forEach(ds=>{
      const cellEvs=evs.filter(e=>e.date===ds&&e.start===hk);
      html+=`<div class="cal-cell" onclick="handleCellClick(event,'${ds}','${hk}')">`;
      if(isFacultyMode)html+=`<div class="add-slot-btn" onclick="openAddForm('${ds}','${hk}');event.stopPropagation()">+</div>`;
      cellEvs.forEach(e=>{
        const dur=Math.max(1,parseInt(e.end)-parseInt(e.start)),hp=dur*52-6,ec=evClass(e);
        const ej=JSON.stringify(e).replace(/'/g,'&#39;').replace(/"/g,'&quot;');
        html+=`<div class="event ${ec}" style="min-height:${hp}px" onclick="handleEventClick(event,${ej})">
          <div class="ev-tag">${e.category}</div>
          <div class="ev-title">${e.title.replace(/Heme\/Onc:\s*/i,'').replace(/\s{2,}/g,' ').trim()}</div>
          <div class="ev-time">${fmtTime(e.start)} ‚Äì ${fmtTime(e.end)}</div>
          ${isFacultyMode?`<div class="ev-controls">
            <button class="ev-ctrl-btn ev-edit-btn" onclick="openEditForm(event,${ej})">‚úé</button>
            <button class="ev-ctrl-btn ev-del-btn" onclick="confirmDelete(event,'${e._id}')">‚úï</button>
          </div>`:''}
        </div>`;
      });
      html+='</div>';
    });
    html+='</div>';
  });
  html+='</div>';
  if(!evs.length)html=`<div class="empty-state"><div class="big">üì≠</div><p>No events match this filter.</p></div>`;
  document.getElementById('calView').innerHTML=html;
}

function renderList(){
  const w=WEEKS[currentWeekIdx];
  const evs=EVENTS.filter(e=>e.weekNum===w.num&&(currentFilter==='All'||e.category===currentFilter)).sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start));
  if(!evs.length){document.getElementById('calView').innerHTML=`<div class="empty-state"><div class="big">üì≠</div><p>No events found.</p></div>`;return;}
  const byDate={};evs.forEach(e=>{if(!byDate[e.date])byDate[e.date]=[];byDate[e.date].push(e);});
  let html='<div style="max-width:700px">';
  Object.keys(byDate).sort().forEach(date=>{
    html+=`<div style="margin-bottom:22px"><div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border)">${fmtDate(date)}</div>`;
    byDate[date].forEach(e=>{
      const col=CAT_COLOR[e.category]||'#4a5168',ec=evClass(e);
      const ej=JSON.stringify(e).replace(/'/g,'&#39;').replace(/"/g,'&quot;');
      html+=`<div class="event ${ec}" style="min-height:auto;flex-direction:row;align-items:center;gap:14px;margin-bottom:7px;padding:10px 14px;border-radius:8px" onclick="handleEventClick(event,${ej})">
        <div style="font-family:'DM Mono',monospace;font-size:10px;color:${col};white-space:nowrap;min-width:90px">${fmtTime(e.start)}<br>${fmtTime(e.end)}</div>
        <div style="flex:1"><div class="ev-tag">${e.category}</div><div style="font-size:13px;font-weight:500">${e.title.replace(/\s{2,}/g,' ').trim()}</div></div>
        ${isFacultyMode?`<div style="display:flex;gap:5px;flex-shrink:0">
          <button class="ev-ctrl-btn ev-edit-btn" style="width:28px;height:28px" onclick="openEditForm(event,${ej})">‚úé</button>
          <button class="ev-ctrl-btn ev-del-btn" style="width:28px;height:28px" onclick="confirmDelete(event,'${e._id}')">‚úï</button>
        </div>`:''}
      </div>`;
    });
    html+='</div>';
  });
  document.getElementById('calView').innerHTML=html+'</div>';
}

// ‚îÄ‚îÄ INTERACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleEventClick(ev,e){ev.stopPropagation();if(isFacultyMode)return;openModal(e);}
function handleCellClick(ev,date,hour){if(!isFacultyMode)return;if(ev.target.closest('.event'))return;openAddForm(date,hour);}
function openModal(e){
  const col=CAT_COLOR[e.category]||'#4a5168';
  document.getElementById('modalBar').style.background=col;
  document.getElementById('modalTitle').textContent=e.title.replace(/\s{2,}/g,' ').trim();
  document.getElementById('modalCat').textContent=e.category;document.getElementById('modalCat').style.color=col;
  document.getElementById('modalDate').textContent=`${fmtDate(e.date)}, ${fmtTime(e.start)} ‚Äì ${fmtTime(e.end)}`;
  document.getElementById('modalBlock').innerHTML=`<span style="color:${BLOCK_COLOR[e.block]||'#fff'}">${e.block}</span>`;
  document.getElementById('modalWeek').textContent=e.week;
  document.getElementById('modalOverlay').classList.add('open');
}

// ‚îÄ‚îÄ FACULTY AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function requestFacultyMode(){document.getElementById('pinInput').value='';document.getElementById('pinErr').textContent='';document.getElementById('loginOverlay').classList.add('open');setTimeout(()=>document.getElementById('pinInput').focus(),100);}
function checkPin(){const val=document.getElementById('pinInput').value.trim();if(val===(CFG.pin||'2028')){document.getElementById('loginOverlay').classList.remove('open');setMode('faculty');}else{document.getElementById('pinErr').textContent='Incorrect PIN.';document.getElementById('pinInput').value='';}}
function setMode(mode){
  isFacultyMode=mode==='faculty';
  document.querySelectorAll('.mode-btn').forEach(b=>{b.classList.remove('active','faculty-active');});
  if(!isFacultyMode)document.querySelectorAll('.mode-btn')[0].classList.add('active');
  else document.querySelectorAll('.mode-btn')[1].classList.add('faculty-active');
  document.getElementById('facultyPanel').classList.toggle('open',isFacultyMode);
  document.getElementById('facultyBadge').style.display=isFacultyMode?'':'none';
  document.getElementById('addEventBtn').style.display=isFacultyMode?'':'none';
  document.getElementById('layout').classList.toggle('faculty-mode',isFacultyMode);
  if(!isFacultyMode)closeForm();
  render();
}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function blockFromWeek(wn){if(wn<=30)return'Heme/Onc';if(wn<=34)return'Respiratory';if(wn<=38)return'Renal';if(wn<=42)return'GI';if(wn<=47)return'Endocrinology';if(wn<=51)return'MSK';return'Break';}
function weekNameFor(wn){const w=WEEKS.find(w=>w.num===wn);return w?w.name:'Week '+wn;}
function formHTML(e,isEdit){
  const w=WEEKS[currentWeekIdx],defBlock=e?e.block:blockFromWeek(w.num),defCat=e?e.category:'Mandatory';
  const blockOpts=BLOCKS_LIST.map(b=>`<option value="${b}" ${defBlock===b?'selected':''}>${b}</option>`).join('');
  const catOpts=CATS_LIST.map(c=>`<option value="${c}" ${defCat===c?'selected':''}>${c}</option>`).join('');
  const weekOpts=WEEKS.map(wk=>`<option value="${wk.num}" ${(e?e.weekNum:w.num)===wk.num?'selected':''}>${wk.name}</option>`).join('');
  const startTimes=['08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00'];
  const endTimes=['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];
  return`<div class="form-group"><label class="form-label">Title *</label><input class="form-input" id="ff_title" value="${(e?e.title:'').replace(/"/g,'&quot;')}" placeholder="e.g. Faculty Discussion"></div>
  <div class="form-group"><label class="form-label">Week</label><select class="form-select" id="ff_week" onchange="updateFormBlock()">${weekOpts}</select></div>
  <div class="form-group"><label class="form-label">Date * (MM/DD/YYYY)</label><input class="form-input" id="ff_date" placeholder="MM/DD/YYYY" value="${e?e.date:(prefillDate||'')}"></div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">Start</label><select class="form-select" id="ff_start">${startTimes.map(t=>`<option value="${t}" ${(e?e.start:(prefillHour||'08:00'))===t?'selected':''}>${fmtTime(t)}</option>`).join('')}</select></div>
    <div class="form-group"><label class="form-label">End</label><select class="form-select" id="ff_end">${endTimes.map(t=>`<option value="${t}" ${(e?e.end:'09:00')===t?'selected':''}>${fmtTime(t)}</option>`).join('')}</select></div>
  </div>
  <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="ff_cat" onchange="updateCatPreview()">${catOpts}</select>
    <div class="color-preview"><div class="color-dot" id="catDot" style="background:${CAT_COLOR[defCat]||'#4f8ef7'}"></div><span style="font-size:11px;color:${CAT_COLOR[defCat]||'#4f8ef7'}" id="catLabel">${defCat}</span></div></div>
  <div class="form-group"><label class="form-label">Block</label><select class="form-select" id="ff_block" onchange="updateBlockPreview()">${blockOpts}</select>
    <div class="color-preview"><div class="color-dot" id="blockDot" style="background:${BLOCK_COLOR[defBlock]||'#7a829a'}"></div><span style="font-size:11px;color:${BLOCK_COLOR[defBlock]||'#7a829a'}" id="blockLabel">${defBlock}</span></div></div>
  <div style="display:flex;flex-direction:column;gap:8px;margin-top:18px">
    <button class="btn-full btn-save" id="saveBtn" onclick="saveForm()">üíæ ${isEdit?'Save Changes':'Add Event'}</button>
    ${isEdit?`<button class="btn-full btn-delete-full" onclick="confirmDelete(null,'${editingId}')">üóë Delete Event</button>`:''}
    <button class="btn-full btn-cancel" onclick="closeForm()">Cancel</button>
  </div>`;
}
function updateCatPreview(){const v=document.getElementById('ff_cat').value,col=CAT_COLOR[v]||'#4a5168';document.getElementById('catDot').style.background=col;document.getElementById('catLabel').textContent=v;document.getElementById('catLabel').style.color=col;}
function updateBlockPreview(){const v=document.getElementById('ff_block').value,col=BLOCK_COLOR[v]||'#7a829a';document.getElementById('blockDot').style.background=col;document.getElementById('blockLabel').textContent=v;document.getElementById('blockLabel').style.color=col;}
function updateFormBlock(){document.getElementById('ff_block').value=blockFromWeek(parseInt(document.getElementById('ff_week').value));updateBlockPreview();}
function openAddForm(date,hour){if(!isFacultyMode)return;editingId=null;prefillDate=date||'';prefillHour=hour||'08:00';document.getElementById('fpSub').textContent='Adding new event';document.getElementById('fpForm').innerHTML=formHTML(null,false);document.getElementById('facultyPanel').scrollTop=0;}
function openEditForm(ev,e){if(ev)ev.stopPropagation();editingId=e._id;document.getElementById('fpSub').textContent='Editing: '+e.title.substring(0,30);document.getElementById('fpForm').innerHTML=formHTML(e,true);document.getElementById('facultyPanel').scrollTop=0;}
function closeForm(){editingId=null;document.getElementById('fpForm').innerHTML='<div style="text-align:center;padding:30px 0;color:var(--muted)"><div style="font-size:28px;margin-bottom:10px">üëÜ</div><div style="font-size:12px;line-height:1.6">Click an event to edit,<br>or a time slot to add,<br>or press <strong style="color:var(--gold)">+ Add Event</strong>.</div></div>';document.getElementById('fpSub').textContent='Click an event to edit ¬∑ Click a slot to add';}

async function saveForm(){
  const title=document.getElementById('ff_title').value.trim();
  const date=document.getElementById('ff_date').value.trim();
  const start=document.getElementById('ff_start').value;
  const end=document.getElementById('ff_end').value;
  const cat=document.getElementById('ff_cat').value;
  const block=document.getElementById('ff_block').value;
  const weekNum=parseInt(document.getElementById('ff_week').value);
  if(!title||!date){showToast('‚ö†Ô∏è Title and Date are required.');return;}
  if(start>=end){showToast('‚ö†Ô∏è End time must be after start time.');return;}
  const btn=document.getElementById('saveBtn');
  btn.textContent='Saving to GitHub...';btn.disabled=true;
  const ev={title,date,start,end,category:cat,block,weekNum,week:weekNameFor(weekNum),desc:title,_id:editingId||(Date.now()+'')};
  try{
    if(editingId){const i=EVENTS.findIndex(e=>e._id===editingId);if(i>=0)EVENTS[i]=ev;}
    else EVENTS.push(ev);
    await saveEventsToGitHub();
    addLog(editingId?'edited':'added',ev);
    showToast(editingId?'‚úÖ Event updated ‚Äî live for everyone!':'‚úÖ Event added ‚Äî live for everyone!');
    closeForm();WEEKS=buildWeeks();buildWeekDrawer();render();
  }catch(err){
    showToast('‚ùå '+err.message);
    btn.textContent='üíæ Save Changes';btn.disabled=false;
  }
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmDelete(ev,id){
  if(ev)ev.stopPropagation();
  pendingDeleteId=id;
  const e=EVENTS.find(e=>e._id===id);
  document.getElementById('confirmMsg').textContent=`Delete "${(e?e.title:'this event').substring(0,50)}"?`;
  document.getElementById('confirmYes').onclick=()=>{doDelete();document.getElementById('confirmOverlay').classList.remove('open');};
  document.getElementById('confirmOverlay').classList.add('open');
}
async function doDelete(){
  const e=EVENTS.find(e=>e._id===pendingDeleteId);if(!e)return;
  const btn=document.getElementById('confirmYes');btn.textContent='Deleting...';btn.disabled=true;
  try{
    EVENTS=EVENTS.filter(ev=>ev._id!==pendingDeleteId);
    await saveEventsToGitHub();
    addLog('deleted',e);showToast('üóë Deleted ‚Äî live for everyone!');
    closeForm();WEEKS=buildWeeks();buildWeekDrawer();render();
  }catch(err){
    EVENTS.push(e); // rollback
    showToast('‚ùå '+err.message);
  }
  btn.textContent='Delete';btn.disabled=false;
}

// ‚îÄ‚îÄ CHANGE LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addLog(type,e){sessionLog.unshift({type,title:e.title,date:e.date,start:e.start,end:e.end,cat:e.category,ts:new Date().toLocaleTimeString()});}
function renderChangeLog(){
  if(!isFacultyMode)return;
  document.getElementById('changeCount').textContent=sessionLog.length?`(${sessionLog.length})`:'';
  if(!sessionLog.length){document.getElementById('changeLog').innerHTML='<div style="font-size:11px;color:var(--muted2);padding:8px 0">No changes this session.</div>';return;}
  document.getElementById('changeLog').innerHTML=sessionLog.slice(0,8).map(e=>`<div class="change-item change-${e.type}"><div class="ch-type">${e.type==='added'?'‚ú¶ Added':e.type==='edited'?'‚úé Edited':'‚úï Deleted'}</div><div class="ch-title">${e.title.substring(0,45)}</div><div class="ch-meta">${e.date} ¬∑ ${fmtTime(e.start)}‚Äì${fmtTime(e.end)} ¬∑ ${e.cat} ¬∑ ${e.ts}</div></div>`).join('');
}

// ‚îÄ‚îÄ ICS EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportICS(){
  function toIcsDt(d,t){const[mo,dy,yr]=d.split('/');const[hr,mn]=t.split(':');return`${yr}${mo}${dy}T${hr}${mn}00`;}
  function esc(s){return(s||'').replace(/\\/g,'\\\\').replace(/;/g,'\\;').replace(/,/g,'\\,').replace(/\n/g,'\\n');}
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//CO2028//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH','X-WR-CALNAME:CO2028 Academic Calendar'];
  EVENTS.forEach((e,i)=>{lines.push('BEGIN:VEVENT',`UID:co2028-${i}@cal`,`DTSTART:${toIcsDt(e.date,e.start)}`,`DTEND:${toIcsDt(e.date,e.end)}`,`SUMMARY:${esc(e.title)}`,`CATEGORIES:${esc(e.category)}`,'STATUS:CONFIRMED','END:VEVENT');});
  lines.push('END:VCALENDAR');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([lines.join('\r\n')],{type:'text/calendar'}));a.download='CO2028_Calendar.ics';a.click();
  showToast('‚úÖ Downloaded ‚Äî open to import into Outlook');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg){let t=document.getElementById('toast');if(!t){t=document.createElement('div');t.id='toast';t.className='toast';document.body.appendChild(t);}t.textContent=msg;t.style.opacity='1';clearTimeout(t._t);t._t=setTimeout(()=>{t.style.opacity='0';},4500);}

document.addEventListener('keydown',ev=>{if(ev.key==='Escape'){document.getElementById('modalOverlay').classList.remove('open');document.getElementById('confirmOverlay').classList.remove('open');closeForm();}});

if(loadConfig())initApp();
else document.getElementById('configOverlay').style.display='flex';
</script>
</body>
</html>